"""
Part 2: ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã¨è©•ä¾¡ï¼ˆãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³æ¸¬å®šï¼‰
============================================
GSM8K ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆï¼ˆå°å­¦æ ¡ãƒ¬ãƒ™ãƒ«ã®æ•°å­¦å•é¡Œï¼‰ã‚’ä½¿ã£ã¦ã€
æœ€é©åŒ–å‰ã®ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³æ­£ç­”ç‡ã‚’æ¸¬å®šã—ã¾ã™ã€‚

DSPy ã®ãƒã‚¤ãƒ³ãƒˆ:
  - ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆãŒçµ„ã¿è¾¼ã¿ã§ç”¨æ„ã•ã‚Œã¦ã„ã‚‹
  - ãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼ˆè©•ä¾¡é–¢æ•°ï¼‰ã‚‚çµ„ã¿è¾¼ã¿ã§ç”¨æ„ã•ã‚Œã¦ã„ã‚‹
  - dspy.Evaluate ã§ç°¡å˜ã«è©•ä¾¡ã§ãã‚‹

å®Ÿè¡Œæ–¹æ³•:
  uv run python 02_evaluate.py
"""

import os

import dspy
from dotenv import load_dotenv
from dspy.datasets.gsm8k import GSM8K, gsm8k_metric
from dspy.evaluate import Evaluate

load_dotenv()

def main():
    print("=" * 60)
    print("Part 2: ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã¨è©•ä¾¡ï¼ˆãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³æ¸¬å®šï¼‰")
    print("=" * 60)

    # ============================================================
    # 1. è¨€èªãƒ¢ãƒ‡ãƒ«ã®è¨­å®š
    # ============================================================
    lm = dspy.LM(os.getenv("OPENAI_MODEL", "openai/gpt-5-nano"))
    dspy.configure(lm=lm)
    print(f"\nâœ… è¨€èªãƒ¢ãƒ‡ãƒ«ã‚’è¨­å®šã—ã¾ã—ãŸ: {lm.model_name}")

    # ============================================================
    # 2. GSM8K ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®èª­ã¿è¾¼ã¿
    # ============================================================
    # GSM8K ã¯å°å­¦æ ¡ãƒ¬ãƒ™ãƒ«ã®æ•°å­¦æ–‡ç« é¡Œã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã§ã™ã€‚
    # DSPy ã«ã¯ã“ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆãŒçµ„ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã™ã€‚
    print("\n" + "-" * 60)
    print("ğŸ”¹ GSM8K ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®èª­ã¿è¾¼ã¿")
    print("-" * 60)

    gsm8k = GSM8K()

    # trainset: æœ€é©åŒ–ï¼ˆå­¦ç¿’ï¼‰ã«ä½¿ã†ãƒ‡ãƒ¼ã‚¿
    # devset:   è©•ä¾¡ã«ä½¿ã†ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ï¼‰
    trainset = gsm8k.train
    devset = gsm8k.dev

    print(f"\n  è¨“ç·´ãƒ‡ãƒ¼ã‚¿æ•°: {len(trainset)}")
    print(f"  è©•ä¾¡ãƒ‡ãƒ¼ã‚¿æ•°: {len(devset)}")

    # ============================================================
    # 3. ãƒ‡ãƒ¼ã‚¿ã®ä¸­èº«ã‚’ç¢ºèª
    # ============================================================
    # dspy.Example ã¯ DSPy ã®ãƒ‡ãƒ¼ã‚¿å‹ã§ã™ã€‚
    # .with_inputs() ã§å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æŒ‡å®šã—ã¾ã™ã€‚
    print("\n" + "-" * 60)
    print("ğŸ”¹ ãƒ‡ãƒ¼ã‚¿ã®ä¸­èº«ã‚’ç¢ºèª")
    print("-" * 60)

    # æœ€åˆã®1ä»¶ã‚’è¡¨ç¤º
    example = trainset[0]
    print(f"\n  ãƒ‡ãƒ¼ã‚¿ã®å‹: {type(example)}")
    print(f"  è³ªå•: {example.question}")
    print(f"  æ­£è§£: {example.answer}")

    # ============================================================
    # 4. ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®å®šç¾©
    # ============================================================
    # ChainOfThought ã‚’ä½¿ã£ãŸã‚·ãƒ³ãƒ—ãƒ«ãªãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã¨ã—ã¾ã™ã€‚
    # ã¾ã ä½•ã‚‚æœ€é©åŒ–ã—ã¦ã„ãªã„çŠ¶æ…‹ã§ã™ã€‚
    print("\n" + "-" * 60)
    print("ğŸ”¹ ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ãƒ—ãƒ­ã‚°ãƒ©ãƒ ï¼ˆæœ€é©åŒ–ãªã—ï¼‰")
    print("-" * 60)

    baseline = dspy.ChainOfThought("question -> answer")
    print("\n  ãƒ—ãƒ­ã‚°ãƒ©ãƒ : dspy.ChainOfThought('question -> answer')")

    # 1ä»¶ã ã‘è©¦ã—ã¦ã¿ã‚‹
    example = devset[0]
    prediction = baseline(question=example.question)
    print(f"\n  è³ªå•: {example.question}")
    print(f"  äºˆæ¸¬: {prediction.answer}")
    print(f"  æ­£è§£: {example.answer}")

    # ============================================================
    # 5. ãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼ˆè©•ä¾¡é–¢æ•°ï¼‰ã®èª¬æ˜
    # ============================================================
    # gsm8k_metric ã¯ DSPy ã«çµ„ã¿è¾¼ã¾ã‚ŒãŸè©•ä¾¡é–¢æ•°ã§ã™ã€‚
    # äºˆæ¸¬çµæœã¨æ­£è§£ã‚’æ¯”è¼ƒã—ã¦ã€æ­£è§£ãªã‚‰ True ã‚’è¿”ã—ã¾ã™ã€‚
    print("\n" + "-" * 60)
    print("ğŸ”¹ ãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼ˆè©•ä¾¡é–¢æ•°ï¼‰")
    print("-" * 60)

    is_correct = gsm8k_metric(example, prediction)
    print(f"\n  gsm8k_metric ã®çµæœ: {is_correct}")
    print("  ï¼ˆäºˆæ¸¬ã¨æ­£è§£ã®æ•°å€¤ã‚’æ¯”è¼ƒã—ã¦æ­£èª¤ã‚’åˆ¤å®šã—ã¾ã™ï¼‰")

    # ============================================================
    # 6. ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã®æ­£ç­”ç‡ã‚’æ¸¬å®š
    # ============================================================
    # dspy.Evaluate ã‚’ä½¿ã£ã¦ã€devset å…¨ä½“ã§ã®æ­£ç­”ç‡ã‚’æ¸¬å®šã—ã¾ã™ã€‚
    # ã“ã‚ŒãŒæœ€é©åŒ–å‰ã®ã€Œãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã€ã«ãªã‚Šã¾ã™ã€‚
    print("\n" + "-" * 60)
    print("ğŸ”¹ ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã®æ­£ç­”ç‡ã‚’æ¸¬å®šä¸­...")
    print("-" * 60)

    evaluator = Evaluate(
        devset=devset,
        metric=gsm8k_metric,
        num_threads=4,           # ä¸¦åˆ—å®Ÿè¡Œæ•°ï¼ˆAPI å‘¼ã³å‡ºã—ã‚’é«˜é€ŸåŒ–ï¼‰
        display_progress=True,   # ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’è¡¨ç¤º
        display_table=5,         # çµæœã®æœ€åˆã®5ä»¶ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º
    )

    baseline_score = evaluator(baseline)

    print(f"\nğŸ“Š ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³æ­£ç­”ç‡: {baseline_score}%")

    # ============================================================
    # ã¾ã¨ã‚
    # ============================================================
    print("\n" + "=" * 60)
    print("ğŸ“Œ Part 2 ã¾ã¨ã‚")
    print("=" * 60)
    print(f"""
ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ï¼ˆæœ€é©åŒ–ãªã—ï¼‰ã®æ­£ç­”ç‡: {baseline_score}%

DSPy ã®è©•ä¾¡ã®ãƒã‚¤ãƒ³ãƒˆ:
  1. GSM8K ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ  â†’ çµ„ã¿è¾¼ã¿ã§åˆ©ç”¨å¯èƒ½
  2. gsm8k_metric       â†’ çµ„ã¿è¾¼ã¿ã®è©•ä¾¡é–¢æ•°
  3. dspy.Evaluate      â†’ ç°¡å˜ã«ãƒãƒƒãƒè©•ä¾¡ãŒå¯èƒ½

æ¬¡ã® Part 3 ã§ã¯ MIPROv2 ã‚’ä½¿ã£ã¦ã“ã®æ­£ç­”ç‡ã‚’è‡ªå‹•çš„ã«æ”¹å–„ã—ã¾ã™ï¼

æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:
  uv run python 03_optimize.py
""")


if __name__ == "__main__":
    main()
