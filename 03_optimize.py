"""
Part 3: MIPROv2 ã«ã‚ˆã‚‹è‡ªå‹•æœ€é©åŒ–
================================
MIPROv2 ã‚’ä½¿ã£ã¦ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è‡ªå‹•çš„ã«æœ€é©åŒ–ã—ã¾ã™ã€‚
æ‰‹å‹•ã§ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ›¸ãæ›ãˆã‚‹ã“ã¨ãªãã€æ­£ç­”ç‡ã‚’å‘ä¸Šã•ã›ã¾ã™ã€‚

MIPROv2 ã®ä»•çµ„ã¿ï¼ˆ3ã‚¹ãƒ†ãƒƒãƒ—ï¼‰:
  1. Bootstrap Few-Shot Examples
     â†’ è¨“ç·´ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æˆåŠŸã—ãŸä¾‹ã‚’ few-shot å€™è£œã¨ã—ã¦åé›†
  2. Propose Instruction Candidates
     â†’ LLM ã‚’ä½¿ã£ã¦é«˜å“è³ªãªå‘½ä»¤æ–‡ï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰ã‚’è¤‡æ•°ç”Ÿæˆ
  3. Bayesian Optimization
     â†’ å‘½ä»¤æ–‡ã¨ few-shot ä¾‹ã®æœ€é©ãªçµ„ã¿åˆã‚ã›ã‚’ãƒ™ã‚¤ã‚ºæœ€é©åŒ–ã§æ¢ç´¢

å®Ÿè¡Œæ–¹æ³•:
  uv run python 03_optimize.py
"""

import dspy
from dotenv import load_dotenv
from dspy.datasets.gsm8k import GSM8K, gsm8k_metric
from dspy.evaluate import Evaluate
from dspy.teleprompt import MIPROv2

load_dotenv()

def main():
    print("=" * 60)
    print("Part 3: MIPROv2 ã«ã‚ˆã‚‹è‡ªå‹•æœ€é©åŒ–")
    print("=" * 60)

    # ============================================================
    # 1. è¨€èªãƒ¢ãƒ‡ãƒ«ã¨ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®è¨­å®š
    # ============================================================
    lm = dspy.LM("openai/gpt-5-nano")
    dspy.configure(lm=lm)
    print("\nâœ… è¨€èªãƒ¢ãƒ‡ãƒ«ã‚’è¨­å®šã—ã¾ã—ãŸ: openai/gpt-5-nano")

    gsm8k = GSM8K()
    trainset = gsm8k.train
    devset = gsm8k.dev
    print(f"âœ… GSM8K ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆè¨“ç·´: {len(trainset)}, è©•ä¾¡: {len(devset)}ï¼‰")

    # ============================================================
    # 2. ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®å®šç¾©
    # ============================================================
    # ã¾ãšæœ€é©åŒ–å‰ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¨æ­£ç­”ç‡ã‚’ç¢ºèªã—ã¾ã™
    print("\n" + "-" * 60)
    print("ğŸ”¹ ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã®æ­£ç­”ç‡ã‚’æ¸¬å®šä¸­...")
    print("-" * 60)

    baseline = dspy.ChainOfThought("question -> answer")

    evaluator = Evaluate(
        devset=devset,
        metric=gsm8k_metric,
        num_threads=4,
        display_progress=True,
    )

    baseline_score = evaluator(baseline)
    print(f"\nğŸ“Š ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³æ­£ç­”ç‡: {baseline_score}%")

    # ============================================================
    # 3. MIPROv2 ã®è¨­å®šã¨å®Ÿè¡Œ
    # ============================================================
    print("\n" + "-" * 60)
    print("ğŸ”¹ MIPROv2 ã«ã‚ˆã‚‹æœ€é©åŒ–ã‚’é–‹å§‹ã—ã¾ã™")
    print("-" * 60)

    # MIPROv2 ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
    # auto ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§æœ€é©åŒ–ã®å¼·åº¦ã‚’è¨­å®š:
    #   "light"  â†’ å°‘ãªã„è©¦è¡Œå›æ•°ã§é«˜é€Ÿï¼ˆãƒ‡ãƒ¢å‘ãï¼‰
    #   "medium" â†’ ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸè¨­å®š
    #   "heavy"  â†’ å¤šãã®è©¦è¡Œå›æ•°ã§é«˜ç²¾åº¦ï¼ˆæœ¬ç•ªå‘ãï¼‰
    teleprompter = MIPROv2(
        metric=gsm8k_metric,  # è©•ä¾¡é–¢æ•°
        auto="light",         # æœ€é©åŒ–ã®å¼·åº¦ï¼ˆãƒ‡ãƒ¢ãªã®ã§ light ã§ååˆ†ï¼‰
    )

    print("\n  æœ€é©åŒ–è¨­å®š:")
    print("    - metric: gsm8k_metricï¼ˆæ•°å€¤ã®å®Œå…¨ä¸€è‡´ï¼‰")
    print('    - auto: "light"ï¼ˆé«˜é€Ÿãƒ¢ãƒ¼ãƒ‰ï¼‰')
    print("\n  ğŸš€ æœ€é©åŒ–ã‚’å®Ÿè¡Œä¸­...ï¼ˆæ•°åˆ†ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰")

    # compile() ã§æœ€é©åŒ–ã‚’å®Ÿè¡Œ
    # trainset ã‚’ä½¿ã£ã¦æœ€é©ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨ few-shot ä¾‹ã‚’æ¢ç´¢ã—ã¾ã™
    optimized_program = teleprompter.compile(
        baseline,              # æœ€é©åŒ–ã™ã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒ 
        trainset=trainset,     # è¨“ç·´ãƒ‡ãƒ¼ã‚¿
    )

    print("\nâœ… æœ€é©åŒ–ãŒå®Œäº†ã—ã¾ã—ãŸï¼")

    # ============================================================
    # 4. æœ€é©åŒ–å¾Œã®æ­£ç­”ç‡ã‚’æ¸¬å®š
    # ============================================================
    print("\n" + "-" * 60)
    print("ğŸ”¹ æœ€é©åŒ–å¾Œã®æ­£ç­”ç‡ã‚’æ¸¬å®šä¸­...")
    print("-" * 60)

    optimized_score = evaluator(optimized_program)
    print(f"\nğŸ“Š æœ€é©åŒ–å¾Œã®æ­£ç­”ç‡: {optimized_score}%")

    # ============================================================
    # 5. Before / After ã®æ¯”è¼ƒ
    # ============================================================
    print("\n" + "-" * 60)
    print("ğŸ”¹ Before / After æ¯”è¼ƒ")
    print("-" * 60)

    improvement = optimized_score - baseline_score
    print(f"""
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³æ­£ç­”ç‡:  {baseline_score:>6.1f}%       â”‚
    â”‚  æœ€é©åŒ–å¾Œã®æ­£ç­”ç‡:    {optimized_score:>6.1f}%       â”‚
    â”‚  æ”¹å–„å¹…:              {improvement:>+6.1f}%       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
""")

    # ============================================================
    # 6. æœ€é©åŒ–æ¸ˆã¿ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ä¿å­˜
    # ============================================================
    print("-" * 60)
    print("ğŸ”¹ æœ€é©åŒ–æ¸ˆã¿ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ä¿å­˜")
    print("-" * 60)

    # JSON ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ã€‚å¾Œã§èª­ã¿è¾¼ã‚“ã§å†åˆ©ç”¨ã§ãã¾ã™ã€‚
    save_path = "optimized_gsm8k.json"
    optimized_program.save(save_path)
    print(f"\nâœ… ä¿å­˜ã—ã¾ã—ãŸ: {save_path}")

    # ============================================================
    # 7. æœ€é©åŒ–ã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ä¸­èº«ã‚’ç¢ºèª
    # ============================================================
    print("\n" + "-" * 60)
    print("ğŸ”¹ æœ€é©åŒ–ã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ä¸­èº«ã‚’ç¢ºèª")
    print("-" * 60)

    # MIPROv2 ãŒè‡ªå‹•ç”Ÿæˆã—ãŸå‘½ä»¤æ–‡ã‚’ç¢ºèª
    for i, predictor in enumerate(optimized_program.predictors()):
        print(f"\n  Predictor {i}:")
        if hasattr(predictor, "extended_signature"):
            sig = predictor.extended_signature
            if sig.instructions:
                print(f"    å‘½ä»¤æ–‡: {sig.instructions[:200]}...")
        if hasattr(predictor, "demos") and predictor.demos:
            print(f"    Few-shot ä¾‹ã®æ•°: {len(predictor.demos)}")

    # ============================================================
    # ã¾ã¨ã‚
    # ============================================================
    print("\n" + "=" * 60)
    print("ğŸ“Œ Part 3 ã¾ã¨ã‚")
    print("=" * 60)
    print(f"""
MIPROv2 ã«ã‚ˆã‚‹æœ€é©åŒ–ã®çµæœ:
  ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³: {baseline_score}% â†’ æœ€é©åŒ–å¾Œ: {optimized_score}% ({improvement:+.1f}%)

MIPROv2 ãŒã‚„ã£ãŸã“ã¨:
  1. è¨“ç·´ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æˆåŠŸã—ãŸ few-shot ä¾‹ã‚’åé›†
  2. é«˜å“è³ªãªå‘½ä»¤æ–‡ï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰ã‚’è‡ªå‹•ç”Ÿæˆ
  3. ãƒ™ã‚¤ã‚ºæœ€é©åŒ–ã§æœ€é©ãªçµ„ã¿åˆã‚ã›ã‚’æ¢ç´¢

ãƒã‚¤ãƒ³ãƒˆ:
  - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’1æ–‡å­—ã‚‚æ‰‹æ›¸ãã—ã¦ã„ãªã„ï¼
  - DSPy ãŒè‡ªå‹•çš„ã«æœ€é©ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç™ºè¦‹
  - optimized_gsm8k.json ã«ä¿å­˜ â†’ ã„ã¤ã§ã‚‚å†åˆ©ç”¨å¯èƒ½

æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:
  uv run python 04_inference.py
""")


if __name__ == "__main__":
    main()
